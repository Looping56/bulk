<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEGO Club Bulk 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --lego-yellow: #FFD700; --lego-red: #D12229; --lego-blue: #0055BF; }
        body { font-family: 'Arial Black', sans-serif; background: #f0f0f0; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; border: 4px solid black; border-radius: 15px; padding: 30px; width: 100%; max-width: 500px; text-align: center; box-shadow: 8px 8px 0px #444; }
        h1 { color: var(--lego-red); -webkit-text-stroke: 1px black; margin-bottom: 20px; }
        input { width: 90%; padding: 12px; margin: 10px 0; border: 3px solid black; border-radius: 8px; font-size: 16px; }
        .btn { background: var(--lego-yellow); border: 3px solid black; padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 8px; width: 100%; margin-top: 10px; }
        .btn:hover { background: white; }
        #view-content { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ§± LEGO CLUB</h1>
    
    <div id="view-login">
        <p>Veuillez vous identifier :</p>
        <input type="text" id="login-nom" placeholder="VOTRE NOM">
        <input type="text" id="login-prenom" placeholder="Votre PrÃ©nom">
        <button class="btn" onclick="connexion()">ENTRER DANS LE CLUB</button>
    </div>

    <div id="view-content" style="display:none;">
    <h2 id="welcome-msg"></h2>
    
    <div id="admin-controls" style="display:none; background:#333; color:white; padding:20px; border-radius:10px; margin-bottom:20px;">
        <h3>ðŸ›  PANNEAU ADMINISTRATEUR</h3>
        <p>Phase actuelle : <strong id="current-phase-display">...</strong></p>
        <button class="btn" onclick="changerPhase('standard')">Ouvrir Phase 1 (Standard)</button>
        <button class="btn" onclick="changerPhase('final')">Ouvrir Phase Finale (Baseplates)</button>
        <button class="btn" style="background:red;" onclick="changerPhase('ferme')">Fermer les votes</button>
        <div id="stats-participation" style="margin-top:15px; background:#444; padding:10px;"></div>
    </div>

    <div id="member-view">
        <h3 id="phase-title">Chargement du catalogue...</h3>
        <div id="catalogue-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;"></div>
        <br>
        <button class="btn" id="btn-valider" onclick="validerChoix()" style="background:var(--lego-red); color:white; width:100%;">VALIDER MA SÃ‰LECTION âœ…</button>
    </div>
</div>
        <p>Le catalogue sera bientÃ´t disponible ici.</p>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const _URL = "https://fmhhcvxhjzvpncoctdyg.supabase.co";
    // ATTENTION : Remplace bien la clÃ© ci-dessous par ta clÃ© "anon public" complÃ¨te
    const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtaGhjdnhoanp2cG5jb2N0ZHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyODc0OTgsImV4cCI6MjA4Nzg2MzQ5OH0.q349gEHEsthu3gqshR8r45gV_9OiKC20qvei3mtpU0s"; 
    const sbClient = supabase.createClient(_URL, _KEY);

    let user = null;
    let phaseActuelle = "";

    async function connexion() {
        const nom = document.getElementById('login-nom').value.toUpperCase().trim();
        const prenom = document.getElementById('login-prenom').value.trim();

        const { data, error } = await sbClient.from('membres').select('*').eq('nom', nom).eq('prenom', prenom).single();

        if (data) {
            user = data;
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-content').style.display = 'block';
            document.getElementById('welcome-msg').innerText = "Bonjour " + data.prenom + " !";

            // VÃ‰RIFICATION DU RÃ”LE
            if (user.est_admin) {
                document.getElementById('admin-controls').style.display = 'block';
                document.getElementById('member-view').style.display = 'none';
                chargerStats();
            } else {
                getPhaseAndLoad();
            }
        } else { alert("Membre non trouvÃ©."); }
    }

    async function getPhaseAndLoad() {
        const { data } = await sbClient.from('config').select('valeur').eq('cle', 'phase_actuelle').single();
        phaseActuelle = data.valeur;
        
        if (phaseActuelle === 'ferme') {
            document.getElementById('member-view').innerHTML = "<h3>Le catalogue est actuellement fermÃ©.</h3>";
        } else {
            chargerCatalogue();
        }
    }

    async function chargerCatalogue() {
        const typeFiltre = (phaseActuelle === 'final') ? 'baseplate' : 'standard';
        document.getElementById('phase-title').innerText = (phaseActuelle === 'final') ? "ðŸ›’ Phase Finale (Max 4 plaques)" : "ðŸ§± Phase 1 (Standard)";
        
        const { data: briques } = await sbClient.from('catalogue').select('*').eq('type_piece', typeFiltre);
        
        const grid = document.getElementById('catalogue-grid');
        grid.innerHTML = briques.map(p => `
            <div class="card" id="p-${p.id}" style="border:2px solid black; padding:10px; border-radius:10px;">
                <small>${p.reference}</small><br>
                <strong>${p.descriptif}</strong><br>
                <button onclick="toggleSelection('${p.id}')">Choisir</button>
            </div>
        `).join('');
    }

    // FONCTION ADMIN POUR CHANGER LA PHASE
    async function changerPhase(nouvellePhase) {
        const { error } = await sbClient.from('config').update({ valeur: nouvellePhase }).eq('cle', 'phase_actuelle');
        if (!error) {
            alert("Phase mise Ã  jour : " + nouvellePhase);
            location.reload();
        }
    }

    async function chargerStats() {
        const { count: total } = await sbClient.from('membres').select('*', { count: 'exact', head: true }).eq('est_admin', false);
        const { data: vus } = await sbClient.from('selections').select('membre_id');
        const nbParticipants = new Set(vus.map(v => v.membre_id)).size;
        
        document.getElementById('stats-participation').innerHTML = `
            Participations : ${nbParticipants} / ${total} membres 
            <div style="width:100%; bg:#eee; height:10px;"><div style="width:${(nbParticipants/total)*100}%; background:green; height:100%;"></div></div>
        `;
    }
</script>

</body>
</html>


